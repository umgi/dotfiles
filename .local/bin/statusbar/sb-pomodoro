#!/bin/sh

log=$XDG_DATA_HOME/atl/log
sound=$XDG_DATA_HOME/atl/sound.mp3

n=$(cat $log | tail -n 1)
n_status=$(echo $n | awk -F, '{print $1}')
n_time=$(echo $n | awk -F, '{print $2}')
n_act=$(echo $n | awk -F, '{print $3}')

diff=$(($(date "+%s") - n_time))
[ $n_status = 'start' ] && icon="ðŸ…" || icon="ðŸ’¤"

seconds=$((diff % 60))
minutes=$((diff / 60 % 60))
hours=$((diff / 3600))

total=0
is_start=0
last_act=""

if [ "$icon" = "ðŸ…" ] ; then
  time=${n_act:4}
  if [ $minutes -ge $time ]; then
    echo "end,$(($(date "+%s") - 1)),$n_act" >> $log

    dunstify "Pomodoro" "Your timer is over"
    pkill -RTMIN+15 dwmblocks
    mpg123 -q "$sound"
    exit 0
  fi
fi


if [ $minutes = '0' ]; then
  time="${seconds}s"
elif [ $hours = '0' ]; then
  time="${minutes}m ${seconds}s"
else
  time="${hours}h ${minutes}m"
fi

printf "%s%s%s" "$icon" "$time" "$( [ "$n_status" = "start" ] && echo " ðŸ˜‹${n_act:4}m" || echo " ago" )"
